<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Engagement Guestbook</title>
<style>
body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  text-align: center;
  padding: 20px;
  background: linear-gradient(to bottom, #fff1f5, #ffe4e1);
  color: #333;
}
h1, h2 { color: #c71585; }
video {
  border: 2px solid #c71585;
  border-radius: 8px;
  margin: 10px 0;
  max-width: 90%;
}
button {
  margin: 5px;
  padding: 12px 25px;
  font-size: 16px;
  cursor: pointer;
  border-radius: 8px;
  border: none;
  background-color: #ff69b4;
  color: white;
  transition: background-color 0.3s;
}
button:hover { background-color: #ff1493; }
input[type=file] { margin: 15px 0; }

/* Modal styling */
#uploadModal {
    display: none;
    position: fixed;
    top:0;
    left:0;
    width:100%;
    height:100%;
    background-color: rgba(0,0,0,0.5);
    z-index:1000;
}
#modalContentWrapper {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100%;
}
#modalContent {
    background:white;
    padding:20px;
    border-radius:10px;
    width:80%;
    max-width:300px;
    text-align:center;
    font-size:18px;
    color:#c71585;
}
.spinner {
  border: 6px solid #f3f3f3;
  border-top: 6px solid #c71585;
  border-radius: 50%;
  width: 40px;
  height: 40px;
  margin: 15px auto;
  animation: spin 1s linear infinite;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
</style>
</head>
<body>
<h1>Welcome to Our Engagement Test 5!</h1>
<h2>Record a Video or Take a Photo for Us ðŸ’–</h2>

<video id="preview" autoplay muted playsinline></video>
<video id="playback" controls playsinline></video>
<br>
<button id="startVideo">Start Video</button>
<button id="stopVideo">Stop Video</button>
<br>
<!-- allow multiple images/videos from camera roll -->
<input type="file" accept="image/*,video/*" id="mediaInput" multiple>
<br>
<button id="send">Send</button>

<!-- Modal -->
<div id="uploadModal">
  <div id="modalContentWrapper">
    <div id="modalContent">
      <div class="spinner" id="spinner"></div>
      <div id="modalText">Uploading...</div>
    </div>
  </div>
</div>

<script>
// ======= Updated recording + multi-file upload logic (cross-browser) =======
let mediaRecorder;
let recordedChunks = [];
let currentMimeType = '';

const preview = document.getElementById('preview');
const playback = document.getElementById('playback');
const startBtn = document.getElementById('startVideo');
const stopBtn = document.getElementById('stopVideo');
const sendBtn = document.getElementById('send');
const mediaInput = document.getElementById('mediaInput');
const modal = document.getElementById('uploadModal');
const modalText = document.getElementById('modalText');
const spinner = document.getElementById('spinner');

// Apps Script web app URL â€” keep yours here
const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzzQQvIFTFHyBQOWFj6cXNywv2LsPFtHXwNEtxbA6x4cX0POZRa8J6lXVmN6N3Pvru_/exec';

// Detect best supported mime type for MediaRecorder
function getSupportedMimeType() {
  if (typeof MediaRecorder === 'undefined') return '';
  if (MediaRecorder.isTypeSupported && MediaRecorder.isTypeSupported('video/webm;codecs=vp9')) return 'video/webm;codecs=vp9';
  if (MediaRecorder.isTypeSupported && MediaRecorder.isTypeSupported('video/webm;codecs=vp8')) return 'video/webm;codecs=vp8';
  if (MediaRecorder.isTypeSupported && MediaRecorder.isTypeSupported('video/mp4')) return 'video/mp4';
  // Fallback
  return 'video/webm';
}

// Initialize camera & recorder
navigator.mediaDevices.getUserMedia({ video: true, audio: true })
.then(stream => {
  preview.srcObject = stream;
  currentMimeType = getSupportedMimeType();

  // Try to create MediaRecorder with the detected mimeType; fall back if it fails
  try {
    mediaRecorder = new MediaRecorder(stream, { mimeType: currentMimeType });
  } catch (err) {
    console.warn('MediaRecorder init with mimeType failed, creating without mimeType. Error:', err);
    mediaRecorder = new MediaRecorder(stream);
    currentMimeType = mediaRecorder.mimeType || currentMimeType || 'video/webm';
  }

  mediaRecorder.ondataavailable = e => { if (e.data && e.data.size > 0) recordedChunks.push(e.data); };
  mediaRecorder.onstop = () => {
    const blob = new Blob(recordedChunks, { type: currentMimeType || 'video/webm' });
    playback.src = URL.createObjectURL(blob);
  };

  startBtn.onclick = () => { recordedChunks = []; mediaRecorder.start(); alert('Recording started!'); };
  stopBtn.onclick = () => { mediaRecorder.stop(); alert('Recording stopped!'); };
})
.catch(err => alert('Camera access denied: ' + err));

// Utility: upload single file (base64 -> Apps Script)
function uploadFileAsBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = function() {
      const base64Data = reader.result.split(',')[1];
      fetch(APPS_SCRIPT_URL, {
        method: 'POST',
        body: new URLSearchParams({
          data: base64Data,
          mimeType: file.type,
          filename: file.name
        })
      })
      .then(res => res.text())
      .then(text => resolve(text))
      .catch(err => reject(err));
    };
    reader.onerror = err => reject(err);
    reader.readAsDataURL(file);
  });
}

// Send: handle recorded video + multiple selected files sequentially
sendBtn.onclick = () => {
  const filesToUpload = [];

  // If a recording exists, add it first
  if (recordedChunks.length > 0) {
    const blob = new Blob(recordedChunks, { type: currentMimeType || 'video/webm' });
    const ext = (currentMimeType && currentMimeType.includes('mp4')) ? 'mp4' : 'webm';
    const filename = `video_${Date.now()}.${ext}`;
    const fileRecorded = new File([blob], filename, { type: blob.type });
    filesToUpload.push(fileRecorded);
  }

  // Add all selected files from input
  if (mediaInput.files && mediaInput.files.length > 0) {
    for (let i = 0; i < mediaInput.files.length; i++) {
      filesToUpload.push(mediaInput.files[i]);
    }
  }

  if (filesToUpload.length === 0) {
    alert('Please record a video or select one or more files first!');
    return;
  }

  // Show modal
  modal.style.display = 'block';
  spinner.style.display = 'block';

  (async () => {
    try {
      for (let i = 0; i < filesToUpload.length; i++) {
        modalText.textContent = `Uploading ${i+1} of ${filesToUpload.length}...`;
        await uploadFileAsBase64(filesToUpload[i]);
      }

      spinner.style.display = 'none';
      modalText.textContent = 'All files uploaded successfully! ðŸŽ‰';

      setTimeout(() => {
        modal.style.display = 'none';
        recordedChunks = [];
        mediaInput.value = '';
        playback.src = '';
      }, 2000);
    } catch (err) {
      console.error('Upload error:', err);
      spinner.style.display = 'none';
      modalText.textContent = 'Upload failed! Please try again.';
      setTimeout(() => { modal.style.display = 'none'; }, 3000);
    }
  })();
};
</script>
</body>
</html>
