<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Engagement Guestbook</title>
<style>
body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  text-align: center;
  padding: 20px;
  background: linear-gradient(to bottom, #fff1f5, #ffe4e1);
  color: #333;
}
h1, h2 { color: #c71585; }
video {
  border: 2px solid #c71585;
  border-radius: 8px;
  margin: 10px 0;
  max-width: 90%;
}
button {
  margin: 5px;
  padding: 12px 25px;
  font-size: 16px;
  cursor: pointer;
  border-radius: 8px;
  border: none;
  background-color: #ff69b4;
  color: white;
  transition: background-color 0.3s;
}
button:hover { background-color: #ff1493; }
input[type=file] { margin: 15px 0; }

/* Modal styling */
#uploadModal {
    display: none;
    position: fixed;
    top:0;
    left:0;
    width:100%;
    height:100%;
    background-color: rgba(0,0,0,0.5);
    z-index:1000;
}
#modalContentWrapper {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100%;
}
#modalContent {
    background:white;
    padding:20px;
    border-radius:10px;
    width:80%;
    max-width:300px;
    text-align:center;
    font-size:18px;
    color:#c71585;
}
.spinner {
  border: 6px solid #f3f3f3;
  border-top: 6px solid #c71585;
  border-radius: 50%;
  width: 40px;
  height: 40px;
  margin: 15px auto;
  animation: spin 1s linear infinite;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
#recordingBadge {
  display: none;
  color: white;
  background-color: red;
  padding: 6px 12px;
  border-radius: 6px;
  font-weight: bold;
  margin: 10px;
}
#actionButtons { display:none; margin-top:10px; }
</style>
</head>
<body>
<h1>Welcome to Our Engagement Test 8!</h1>
<h2>Record a Video or Take a Photo for Us üíñ</h2>

<div id="recordingBadge">‚óè Recording...</div>
<video id="preview" autoplay muted playsinline></video>
<video id="playback" controls playsinline></video>
<br>
<button id="startVideo">Start Video</button>
<button id="stopVideo">Stop Video</button>
<br>
<input type="file" accept="image/*,video/*" id="mediaInput" multiple>
<br>
<div id="actionButtons">
  <button id="send">Send</button>
  <button id="discard">Discard</button>
</div>

<div id="uploadModal">
  <div id="modalContentWrapper">
    <div id="modalContent">
      <div class="spinner" id="spinner"></div>
      <div id="modalText">Uploading...</div>
    </div>
  </div>
</div>

<script>
let mediaRecorder;
let recordedChunks = [];
let currentMimeType = '';
const preview = document.getElementById('preview');
const playback = document.getElementById('playback');
const startBtn = document.getElementById('startVideo');
const stopBtn = document.getElementById('stopVideo');
const sendBtn = document.getElementById('send');
const discardBtn = document.getElementById('discard');
const actionButtons = document.getElementById('actionButtons');
const mediaInput = document.getElementById('mediaInput');
// Show action buttons when user selects files manually
mediaInput.addEventListener('change', () => {
  if(mediaInput.files.length > 0) {
    actionButtons.style.display = 'block';
  } else if(recordedChunks.length === 0) {
    actionButtons.style.display = 'none';
  }
});
const modal = document.getElementById('uploadModal');
const modalText = document.getElementById('modalText');
const spinner = document.getElementById('spinner');
const recordingBadge = document.getElementById('recordingBadge');
const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzzQQvIFTFHyBQOWFj6cXNywv2LsPFtHXwNEtxbA6x4cX0POZRa8J6lXVmN6N3Pvru_/exec';

function getSupportedMimeType() {
  if (typeof MediaRecorder === 'undefined') return '';
  if (MediaRecorder.isTypeSupported && MediaRecorder.isTypeSupported('video/webm;codecs=vp9')) return 'video/webm;codecs=vp9';
  if (MediaRecorder.isTypeSupported && MediaRecorder.isTypeSupported('video/webm;codecs=vp8')) return 'video/webm;codecs=vp8';
  if (MediaRecorder.isTypeSupported && MediaRecorder.isTypeSupported('video/mp4')) return 'video/mp4';
  return 'video/webm';
}

navigator.mediaDevices.getUserMedia({ video: true, audio: true })
.then(stream => {
  preview.srcObject = stream;
  currentMimeType = getSupportedMimeType();
  try {
    mediaRecorder = new MediaRecorder(stream, { mimeType: currentMimeType });
  } catch (err) {
    console.warn('MediaRecorder init with mimeType failed, creating without mimeType.', err);
    mediaRecorder = new MediaRecorder(stream);
    currentMimeType = mediaRecorder.mimeType || currentMimeType || 'video/webm';
  }

  mediaRecorder.ondataavailable = e => { if(e.data && e.data.size>0) recordedChunks.push(e.data); };
  mediaRecorder.onstop = () => {
    const blob = new Blob(recordedChunks, { type: currentMimeType || 'video/webm' });
    playback.src = URL.createObjectURL(blob);
    actionButtons.style.display = 'block';
  };

  startBtn.onclick = () => { recordedChunks = []; mediaRecorder.start(); recordingBadge.style.display = 'inline-block'; actionButtons.style.display='none'; playback.src=''; };
  stopBtn.onclick = () => { mediaRecorder.stop(); recordingBadge.style.display = 'none'; };
});

discardBtn.onclick = () => { recordedChunks=[]; playback.src=''; actionButtons.style.display='none'; mediaInput.value = '';};

function uploadFileAsBase64(file){
  return new Promise((resolve,reject)=>{
    const reader=new FileReader();
    reader.onload=function(){
      const base64Data=reader.result.split(',')[1];
      fetch(APPS_SCRIPT_URL,{
        method:'POST',
        body:new URLSearchParams({ data: base64Data, mimeType:file.type, filename:file.name })
      }).then(res=>res.text()).then(resolve).catch(reject);
    };
    reader.onerror=err=>reject(err);
    reader.readAsDataURL(file);
  });
}

sendBtn.onclick = async () => {
  const filesToUpload = [];
  if(recordedChunks.length>0){
    const blob=new Blob(recordedChunks,{type:currentMimeType||'video/webm'});
    const ext=(currentMimeType && currentMimeType.includes('mp4'))?'mp4':'webm';
    filesToUpload.push(new File([blob],`video_${Date.now()}.${ext}`,{type:blob.type}));
  }
  if(mediaInput.files.length>0) filesToUpload.push(...Array.from(mediaInput.files));
  if(filesToUpload.length===0){alert('Please record a video or select one or more files first!'); return;}

  modal.style.display='block'; spinner.style.display='block';
  try{
    for(let i=0;i<filesToUpload.length;i++){
      modalText.textContent=`Uploading ${i+1} of ${filesToUpload.length}...`;
      await uploadFileAsBase64(filesToUpload[i]);
    }
    spinner.style.display='none'; modalText.textContent='All files uploaded successfully! üéâ';
    setTimeout(()=>{ modal.style.display='none'; recordedChunks=[]; mediaInput.value=''; playback.src=''; actionButtons.style.display='none'; },2000);
  }catch(err){
    console.error(err); spinner.style.display='none'; modalText.textContent='Upload failed! Please try again.';
    setTimeout(()=>{ modal.style.display='none'; },3000);
  }
};
</script>
</body>
</html>



